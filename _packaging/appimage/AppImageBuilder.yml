# appimage-builder recipe see https://appimage-builder.readthedocs.io for details
version: 1
script:
  # Remove any previous build
  - rm -rf AppDir  | true
  - mkdir -p AppDir/usr/lib/python3.10
  - mkdir -p AppDir/usr/bin
  # Install python3.10
  # TODO: Move Python from the setup-python GitHub Action
  - cp /usr/local/bin/python3.10 /usr/local/bin/pip3.10 AppDir/usr/bin
  - cp -r /usr/local/lib/python3.10/ AppDir/usr/lib/python3.10/
  - ln -sr AppDir/usr/bin/python3.10 AppDir/usr/bin/python
  # Make usr and icons dirs
  - mkdir -p AppDir/usr/src
  - mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps/32x32
  # Copy the python application code into the AppDir
  - cp ../../gaphor  AppDir/usr/src -r
  # Add the application's icon
  - cp org.gaphor.Gaphor.png AppDir/usr/share/icons/hicolor/scalable/apps/32x32/
  # Generate the requirements.txt file
  - export PYTHONPATH="$(pwd)/AppDir/usr/lib/python3.10/site-packages"
  - export LD_LIBRARY_PATH=$(pwd)/AppDir/usr/lib
  - AppDir/usr/bin/python3.10 -m pip install --upgrade pip
  - AppDir/usr/bin/python3.10 -m pip install poetry
  - AppDir/usr/bin/python3.10 -m poetry export --without-hashes > requirements.txt
  # Install application dependencies in AppDir
  - AppDir/usr/bin/python3.10 -m pip install --upgrade --isolated --no-input --ignore-installed --prefix=./AppDir/usr wheel
  - AppDir/usr/bin/python3.10 -m pip install --upgrade --isolated --no-input --ignore-installed --prefix=./AppDir/usr -r ./requirements.txt
  - AppDir/usr/bin/python3.10 -m pip install --upgrade --isolated --no-input --ignore-installed --prefix=./AppDir/usr ../../dist/gaphor-2.7.1-py3-none-any.whl
AppDir:
  path: ./AppDir
  app_info:
    id: org.gaphor.Gaphor
    name: Gaphor
    version: latest
    icon: org.gaphor.Gaphor
    exec: usr/bin/python
    exec_args: "-m gaphor"
  apt:
    arch: amd64
    sources:
      - sourceline: 'deb http://archive.ubuntu.com/ubuntu/ groovy main restricted universe multiverse'
        key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920D1991BC93C'

    include:
    - dconf-gsettings-backend
    - libbz2-1.0
    - libcanberra-gtk3-module
    - libcanberra-pulse
    - libexpat1
    - libgcc-s1
    - libgirepository1.0-dev
    - libgpg-error0
    - libpcre3
    - libprocps8
    - libpython3.8-stdlib
    - librsvg2-common
    - libselinux1
    - python3-gi-cairo
    - gir1.2-gtk-3.0
    - adwaita-icon-theme
    - gir1.2-handy-1
    - gir1.2-notify-0.7
    - libglib2.0-bin
    - ibus-gtk3
    - zlib1g
 
    exclude: []

  runtime:
    env:
      # Set python home
      PYTHONPATH: '${APPDIR}/usr/lib/python3.10/dist-packages'
      GTK_THEME: Adwaita
  files:
    include:
      - /usr/bin/env
      - /bin/bash
      - /usr/bin/bash
      - /usr/bin/sh
  test:
    fedora-30:
      image: appimagecrafters/tests-env:fedora-30
      command: ./AppRun
      use_host_x: true
      env:
        LD_DEBUG: libs
        PYTHONHOME: /app//usr/lib/python3.10
    debian-stable:
      image: appimagecrafters/tests-env:debian-stable
      command: ./AppRun
      use_host_x: true
    archlinux-latest:
      image: appimagecrafters/tests-env:archlinux-latest
      command: ./AppRun
      use_host_x: true
    centos-7:
      image: appimagecrafters/tests-env:centos-7
      command: ./AppRun
      use_host_x: true
    ubuntu-xenial:
      image: appimagecrafters/tests-env:ubuntu-xenial
      command: ./AppRun
      use_host_x: true
AppImage:
  arch: x86_64
  update-information: guess
